name: Deploy pages (multi-lecture, simple)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: pages
  cancel-in-progress: true

env:
  REPO: ${{ github.event.repository.name }}  # e.g., ps_211

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9.2.0
          run_install: false

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install deps
        run: pnpm install --frozen-lockfile

      - name: Discover & build all lecture*.md
        shell: bash
        run: |
          set -e
          shopt -s nullglob

          # Build directory
          rm -rf dist
          mkdir -p dist

          # Find lecture decks
          lectures=(lecture*.md)
          if [ ${#lectures[@]} -eq 0 ]; then
            echo "No lecture*.md files found."
            exit 1
          fi
          echo "Found lectures: ${lectures[*]}"

          # Build each deck into dist/<slug>/ with correct base /<repo>/<slug>/
          for f in "${lectures[@]}"; do
            slug="${f%.md}"
            echo "üì¶ Building $f ‚Üí dist/$slug  (base=/${REPO}/${slug}/)"
            pnpm exec slidev build "$f" \
              --base "/${REPO}/${slug}/" \
              --out "dist/${slug}"
          done

          # Publish PDFs placed in repo at public/pdfs/*
          mkdir -p dist/pdfs
          if [ -d public/pdfs ]; then
            cp -R public/pdfs/. dist/pdfs/
          fi

          # If you provided a custom site in /public, copy it into dist/
          if [ -d public ]; then
            rsync -a --exclude 'pdfs' public/ dist/
          fi

          # Auto-generate a slides index page at /slides/
          mkdir -p dist/slides
          {
            echo '<!doctype html><meta charset="utf-8"><title>PS 211 ‚Äî Slides</title>'
            echo '<style>body{font:16px/1.5 system-ui,sans-serif;max-width:860px;margin:2rem auto;padding:0 1rem}ul{line-height:1.9}</style>'
            echo '<h1>Slide Decks</h1><ul>'
            for d in dist/*/ ; do
              [ -f "${d}index.html" ] || continue
              dname=$(basename "$d")
              case "$dname" in pdfs|slides) continue;; esac
              echo "<li><a href=\"/${REPO}/${dname}/\">${dname}</a></li>"
            done
            echo '</ul>'
          } > dist/slides/index.html

          # If no custom index.html provided, fall back to a simple one
          if [ ! -f dist/index.html ]; then
            {
              echo '<!doctype html><meta charset="utf-8"><title>PS 211</title>'
              echo '<style>body{font:16px/1.5 system-ui,sans-serif;max-width:800px;margin:2rem auto;padding:0 1rem}ul{line-height:1.8}</style>'
              echo '<h1>PS 211 ‚Äî Slide Decks</h1>'
              echo '<p><a href="pdfs/">üìÑ PDFs</a> ¬∑ <a href="slides/">üìΩÔ∏è Slides</a></p>'
            } > dist/index.html
          fi

          # /pdfs index that lists all uploaded PDFs
          {
            echo '<!doctype html><meta charset="utf-8"><title>PS 211 ‚Äî PDFs</title>'
            echo '<style>body{font:16px/1.5 system-ui,sans-serif;max-width:800px;margin:2rem auto;padding:0 1rem}ul{line-height:1.8}</style>'
            echo '<h1>Downloadable PDFs</h1><ul>'
            if [ -d dist/pdfs ]; then
              find dist/pdfs -maxdepth 1 -type f -name '*.pdf' -printf '%f\n' | sort | while read -r f; do
                echo "<li><a href=\"$f\">$f</a></li>"
              done
            fi
            echo '</ul>'
          } > dist/pdfs/index.html

      - name: Configure Pages
        uses: actions/configure-pages@v4

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: dist

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4